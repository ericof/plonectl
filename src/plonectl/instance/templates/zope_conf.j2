# File generated by {{ debug.app }} at {{ debug.date }}
%define INSTANCEHOME {{ context.target }}
instancehome $INSTANCEHOME

%define CLIENTHOME {{ context.location_clienthome }}
clienthome $CLIENTHOME

debug-mode {{ "on" if context.debug_mode == "True" else "off" }}
security-policy-implementation {{ "PYTHON" if context.verbose_security == "True" else "C"}}
verbose-security {{ "on" if context.verbose_security =="True" else "off" }}

default-zpublisher-encoding utf-8

{%- if context.environment %}
<environment>
{%- for key, value in context.environment|dictsort %}
    {{ key }} {{ value }}
{%- endfor %}

</environment>
{%- endif %}

{%- if context.dos_protection_available %}
<dos_protection>
    form-memory-limit {{ context.dos_protection_form_memory_limit }}
    form-disk-limit {{ context.dos_protection_form_disk_limit }}
    form-memfile-limit {{ context.dos_protection_form_memfile_limit }}
</dos_protection>
{%- endif %}

# Database
<zodb_db main>
    mount-point /
    cache-size {{ context.db_cache_size }}
{%- if context.db_cache_size_bytes %}
    cache-size-bytes {{ context.db_cache_size_bytes }}
{%- endif %}
{%- if context.db_large_record_size %}
    large-record-size {{ context.db_large_record_size }}
{%- endif %}
{%- if context.db_pool_size %}
    pool-size {{ context.db_pool_size }}
{%- endif %}
{%- if context.db_storage == "direct" %}
    # Blob-enabled FileStorage database
    <filestorage>
        path {{ context.db_filestorage_location}}
        blob-dir {{ context.db_blobs_location }}
        pack-keep-old {{ "true" if context.db_filestorage_pack_keep_old else "false" }}
{%- if context.db_filestorage_quota %}
        quota {{ context.db_filestorage_quota }}
{%- endif %}
{%- if context.db_filestorage_packer %}
        packer {{ context.db_filestorage_packer }}
{%- endif %}
{%- if context.db_filestorage_pack_gc %}
        pack-gc {{ context.db_filestorage_pack_gc }}
{%- endif %}
    </filestorage>
{%- endif %}
{%- if context.db_storage == "relstorage" %}
    # RelStorage
    %import relstorage
    <relstorage>
        # blobs
        shared-blob-dir {{ "true" if context.db_blobs_mode == "shared" else "false" }}
        blob-dir {{ context.db_blobs_location }}
        # general settings
        keep-history {{ context.db_relstorage_keep_history|lower }}
        read-only {{ context.db_relstorage_read_only|lower }}
        create-schema {{ context.db_relstorage_create_schema|lower}}
{%- if context.db_relstorage_commit_lock_timeout %}
        commit-lock-timeout {{ context.db_relstorage_commit_lock_timeout }}
{%- endif %}
{%- if context.db_relstorage_blob_cache_size_check_external %}
        blob-cache-size-check-external {{ context.db_relstorage_blob_cache_size_check_external }}
{%- endif %}
{%- if context.db_relstorage_blob_chunk_size %}
        blob-chunk-size {{ context.db_relstorage_blob_chunk_size }}
{%- endif %}
{%- if context.db_relstorage_cache_local_mb %}
        cache-local-mb {{ context.db_relstorage_cache_local_mb }}
{%- endif %}
{%- if context.db_relstorage_cache_local_object_max %}
        cache-local-object-max {{ context.db_relstorage_cache_local_object_max }}
{%- endif %}
{%- if context.db_relstorage_cache_local_compression %}
        cache-local-compression {{ context.db_relstorage_cache_local_compression }}
{%- endif %}
{%- if context.db_relstorage_cache_local_dir %}
        cache-local-dir {{ context.db_relstorage_cache_local_dir }}
{%- endif %}
{%- if context.db_relstorage_cache_prefix %}
        cache-prefix {{ context.db_relstorage_cache_prefix }}
{%- endif %}
{%- if context.db_relstorage_replica_conf %}
        replica-conf {{ context.db_relstorage_replica_conf }}
{%- endif %}
{%- if context.db_relstorage_ro_replica_conf %}
        ro-replica-conf {{ context.db_relstorage_ro_replica_conf }}
{%- endif %}
{%- if context.db_relstorage_replica_timeout %}
        replica-timeout {{ context.db_relstorage_replica_timeout }}
{%- endif %}
{%- if context.db_relstorage_replica_revert_when_stale %}
        replica-revert-when-stale {{ context.db_relstorage_replica_revert_when_stale }}
{%- endif %}
{%- if context.db_relstorage_commit_lock_id %}
        # only relevant if oracle is used
        commit-lock-id {{ context.db_relstorage_commit_lock_id }}
{%- endif %}
{%- if context.db_relstorage == "postgresql" %}
        <postgresql>
            driver {{ context.db_relstorage_postgresql_driver }}
            dsn {{ context.db_relstorage_postgresql_dsn }}
        </postgresql>
{%- endif %}
{%- if context.db_relstorage == "mysql" %}
        <mysql>
            driver {{ context.db_relstorage_mysql_driver }}
{%- for key, value in context.db_relstorage_mysql_parameters|dictsort %}
            {{ key }} {{ value }}
{%- endfor %}
        </mysql>
{%- endif %}
{%- if context.db_relstorage == "oracle" %}
        <oracle>
            driver {{ context.db_relstorage_oracle_driver }}
            user {{ context.db_relstorage_oracle_user }}
            password {{ context.db_relstorage_oracle_password }}
            dsn {{ context.db_relstorage_oracle_dsn }}
        </oracle>
{%- endif %}
{%- if context.db_relstorage == "sqlite3" %}
        <sqlite3>
            driver {{ context.db_relstorage_sqlite3_driver }}
            data-dir {{ context.db_relstorage_sqlite3_data_dir }}
{%- if context.db_relstorage_sqlite3_gevent_yield_interval %}
            gevent-yield-interval {{ context.db_relstorage_sqlite3_gevent_yield_interval }}
{%- endif %}
{%- if context.db_relstorage_sqlite3_pragma %}
            <pragma>
{%- for key, value in context.db_relstorage_sqlite3_pragma|dictsort %}
                {{ key }} {{ value }}
{%- endfor %}
            </pragma>
{%- endif %}
        </sqlite3>
{%- endif %}
    </relstorage>
{%- endif %}
{%- if context.db_storage == "zeo" %}
    # ZEO storage
    <zeoclient>
        # blobs
        shared-blob-dir {{ "true" if context.db_blobs_mode == "shared" else "false" }}
        blob-dir {{ context.db_blobs_location }}
        # general settings
        server {{ context.db_zeo_server }}
        name {{ context.db_zeo_name }}
{%- if context.db_zeo_client %}
        # persistent caching
        client {{ context.db_zeo_client }}
{%- if context.db_zeo_var %}
        var {{ context.db_zeo_var }}
{%- endif %}
{%- endif %}
{%- if context.db_zeo_cache_size %}
        cache-size {{ context.db_zeo_cache_size }}
{%- endif %}
{%- if context.db_zeo_username %}
        # Authentication
        username {{ context.db_zeo_username }}
        password {{ context.db_zeo_password }}
{%- if context.db_zeo_realm %}
        realm {{ context.db_zeo_realm }}
{%- endif %}
{%- endif %}
        # Advanced options
{%- if context.db_zeo_read_only_fallback %}
        read-only-fallback true
{%- endif %}
{%- if context.db_zeo_read_only %}
        read-only true
{%- endif %}
{%- if context.db_zeo_drop_cache_rather_verify %}
        drop-cache-rather-verify {{ context.db_zeo_drop_cache_rather_verify }}
{%- endif %}
    </zeoclient>
{%- endif %}
</zodb_db>
